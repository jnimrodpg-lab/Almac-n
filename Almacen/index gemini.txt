<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ubicaci√≥n de productos + Mapa</title>

<style>
  body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
  h2 { text-align: center; color: #1a73e8; }
  
  /* --- ESTILOS DEL MAPA --- */
  .contenedor-mapa {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    text-align: center;
  }
  
  /* Dibujamos un croquis simple con CSS/SVG */
  #mapa-tienda {
    width: 100%;
    max-width: 500px;
    height: auto;
    border: 2px solid #333;
    background: #fff;
  }

  /* Estante por defecto */
  .estante { fill: #e0e0e0; stroke: #333; stroke-width: 2; transition: all 0.3s; }
  
  /* Clase cuando se encuentra el producto */
  .highlight { fill: #ffc107 !important; stroke: #ff5722 !important; stroke-width: 4; }
  .texto-estante { font-size: 12px; font-weight: bold; pointer-events: none; }

  /* --- BUSCADOR Y TABLA --- */
  input { width: 100%; padding: 15px; margin-bottom: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
  .btn { width: 100%; padding: 12px; margin-bottom: 10px; font-size: 16px; color: white; border: none; border-radius: 5px; cursor: pointer; }
  .btn-blue { background: #007bff; }
  .btn-red { background: #dc3545; }
  
  table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
  th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
  th { background: #007bff; color: white; }
  tr.seleccionado { background-color: #fff3cd !important; font-weight: bold; }
</style>
</head>
<body>

<h2>üì¶ Localizador de Inventario</h2>

<div class="contenedor-mapa">
  <p><strong>Plano de la Tienda / Almac√©n</strong></p>
  <svg id="mapa-tienda" viewBox="0 0 400 300">
    <rect x="5" y="5" width="390" height="290" fill="none" stroke="black" stroke-width="3"/>
    
    <rect id="A1" class="estante" x="20" y="20" width="60" height="100" />
    <text x="35" y="75" class="texto-estante">A1</text>

    <rect id="A2" class="estante" x="100" y="20" width="60" height="100" />
    <text x="115" y="75" class="texto-estante">A2</text>

    <rect id="B1" class="estante" x="250" y="20" width="120" height="40" />
    <text x="295" y="45" class="texto-estante">B1</text>

    <rect id="B2" class="estante" x="250" y="80" width="120" height="40" />
    <text x="295" y="105" class="texto-estante">B2</text>

    <rect id="C1" class="estante" x="20" y="180" width="150" height="80" />
    <text x="80" y="225" class="texto-estante">C1 (ALMAC√âN)</text>
  </svg>
  <div id="info-ubicacion" style="margin-top:10px; color:#d93025; font-weight:bold;"></div>
</div>

<input type="text" id="buscar" placeholder="Escanea o escribe nombre/ubicaci√≥n..." autofocus>

<button id="btnScan" class="btn btn-blue">üì∑ Escanear con c√°mara</button>
<button id="btnCerrar" class="btn btn-red" style="display:none;">‚ùå Cerrar c√°mara</button>

<div id="reader" style="width:100%; display:none; margin-bottom: 20px;"></div>

<table>
  <thead>
    <tr>
      <th>Nombre Bsale</th>
      <th>Variante</th>
      <th>Ubicaci√≥n</th>
    </tr>
  </thead>
  <tbody id="tabla"></tbody>
</table>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const sheetID   = "1IU4wMdVImmEbl93kgcCCQAGPiTc28uQdNNaq0bgTF2o";
const sheetName = "Mujer";
const tabla     = document.getElementById("tabla");
const buscador  = document.getElementById("buscar");
const infoUbic  = document.getElementById("info-ubicacion");

// 1. Cargar Datos
fetch(`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const rows = json.table.rows;
    let html = "";

    rows.forEach(r => {
      if (!r.c) return;
      const barras   = r.c[10]?.v || "";
      const nombre   = r.c[12]?.v || "";
      const variante = r.c[13]?.v || "";
      const ubic     = String(r.c[20]?.v || "").trim().toUpperCase();

      if (!barras && !nombre) return;

      html += `<tr data-ubic="${ubic}" data-fulltext="${barras} ${nombre} ${variante} ${ubic}">
                <td>${nombre}</td>
                <td>${variante}</td>
                <td class="col-ubic">${ubic}</td>
              </tr>`;
    });
    tabla.innerHTML = html;
  });

// 2. L√≥gica de B√∫squeda y Resaltado de Mapa
buscador.addEventListener("input", () => {
  const filtro = buscador.value.toLowerCase().trim();
  
  // Limpiar resaltados previos
  document.querySelectorAll('.estante').forEach(e => e.classList.remove('highlight'));
  document.querySelectorAll('tr').forEach(tr => tr.classList.remove('seleccionado'));
  infoUbic.innerText = "";

  if(filtro === "") return;

  let ubicacionEncontrada = "";

  document.querySelectorAll("#tabla tr").forEach(tr => {
    const contenido = tr.getAttribute("data-fulltext").toLowerCase();
    
    if (contenido.includes(filtro)) {
      tr.style.display = "";
      // Si el filtro es muy espec√≠fico (como un escaneo de barras), tomamos la ubicaci√≥n
      ubicacionEncontrada = tr.getAttribute("data-ubic");
      tr.classList.add('seleccionado');
    } else {
      tr.style.display = "none";
    }
  });

  // Resaltar en el mapa si existe el ID
  if (ubicacionEncontrada) {
    const estanteElement = document.getElementById(ubicacionEncontrada);
    if (estanteElement) {
      estanteElement.classList.add('highlight');
      infoUbic.innerText = `üìç Ubicado en: ${ubicacionEncontrada}`;
    }
  }
});

// 3. Esc√°ner (Mantenemos tu l√≥gica funcional)
const btnScan = document.getElementById("btnScan");
const btnCerrar = document.getElementById("btnCerrar");
const readerDiv = document.getElementById("reader");
let html5QrCode = null;

btnScan.addEventListener("click", () => {
  readerDiv.style.display = "block";
  btnCerrar.style.display = "block";
  html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras => {
    const cameraId = cameras.find(c => c.label.toLowerCase().includes("back"))?.id || cameras[0].id;
    html5QrCode.start(cameraId, { fps: 20, qrbox: { width: 250, height: 250 } }, 
    codigo => {
      buscador.value = codigo;
      buscador.dispatchEvent(new Event("input"));
      detenerCamara();
    });
  });
});

function detenerCamara() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      readerDiv.style.display = "none";
      btnCerrar.style.display = "none";
    });
  }
}

btnCerrar.addEventListener("click", detenerCamara);
</script>

</body>
</html>